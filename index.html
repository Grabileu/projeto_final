<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="GUF Sistemas - Gerenciamento Profissional de Funcion√°rios e Quebras de Caixa">
  <meta name="theme-color" content="#3b82f6">
  <title>GUF Sistemas ‚Äî Gest√£o Profissional v2.0</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="professional-styles.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar" aria-label="Menu principal">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="3" width="18" height="18" rx="4" fill="#3B82F6"/>
            <path d="M7 12h10M7 16h6" stroke="#fff" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <strong class="app-name">GUF Sistemas</strong>
      </div>

      <nav class="nav">
        <ul>
          <li class="nav-item active" data-target="dashboard">
            <button class="nav-btn" aria-expanded="false">
              <span class="nav-icon" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="3" y="3" width="7" height="7" rx="1" fill="#1F2937"/>
                  <rect x="14" y="3" width="7" height="7" rx="1" fill="#1F2937"/>
                  <rect x="3" y="14" width="7" height="7" rx="1" fill="#1F2937"/>
                  <rect x="14" y="14" width="7" height="7" rx="1" fill="#1F2937"/>
                </svg>
              </span>
              <span class="nav-label">Dashboard</span>
            </button>
          </li>
          <li class="nav-item has-sub" data-target="funcionarios">
            <button class="nav-btn" aria-expanded="false">
              <span class="nav-icon" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z" fill="#1F2937"/>
                  <path d="M4 20a8 8 0 0116 0" stroke="#1F2937" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <span class="nav-label">Funcion√°rios</span>
              <span class="chev" aria-hidden="true">‚ñæ</span>
            </button>

            <ul class="subnav" aria-label="Submenu funcion√°rios">
              <li class="subnav-item" data-target="funcionario">
                <button class="subnav-btn">Funcion√°rio</button>
              </li>
              <li class="subnav-item" data-target="faltas">
                <button class="subnav-btn">Faltas</button>
              </li>
              <li class="subnav-item" data-target="quebras">
                <button class="subnav-btn">Quebras de caixa</button>
              </li>
            </ul>
          </li>
          <li class="nav-item has-sub" data-target="ceasa">
            <button class="nav-btn" aria-expanded="false">
              <span class="nav-icon" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 10h18M5 14h14M4 18h16" stroke="#1F2937" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </span>
              <span class="nav-label">Ceasa</span>
              <span class="chev" aria-hidden="true">‚ñæ</span>
            </button>

            <ul class="subnav" aria-label="Submenu ceasa">
              <li class="subnav-item" data-target="ceasa-compras">
                <button class="subnav-btn">Compras</button>
              </li>
              <li class="subnav-item" data-target="ceasa-fornecedores">
                <button class="subnav-btn">Fornecedores</button>
              </li>
            </ul>
          </li>
          <li class="nav-item has-sub" data-target="relatorios">
            <button class="nav-btn" aria-expanded="false">
              <span class="nav-icon" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 3h6v2H9V3zm-4 4h14v2H5V7zm0 4h14v2H5v-2zm0 4h10v2H5v-2z" fill="#1F2937"/>
                </svg>
              </span>
              <span class="nav-label">Relat√≥rios</span>
              <span class="chev" aria-hidden="true">‚ñæ</span>
            </button>

            <ul class="subnav" aria-label="Submenu relat√≥rios">
              <li class="subnav-item" data-target="relatorios-quebras">
                <button class="subnav-btn">Quebras de caixa</button>
              </li>
              <li class="subnav-item" data-target="relatorios-faltas-atestados">
                <button class="subnav-btn">Faltas e Atestados</button>
              </li>
              <li class="subnav-item" data-target="relatorios-ceasa">
                <button class="subnav-btn">Ceasa</button>
              </li>
              <li class="subnav-item" data-target="relatorios-funcionarios">
                <button class="subnav-btn">Funcion√°rios</button>
              </li>
            </ul>
          </li>
        </ul>
      </nav>

      <div class="sidebar-footer">
        <button class="btn-settings" id="btnSettings" title="Configura√ß√µes do servidor" aria-label="Configura√ß√µes">‚öôÔ∏è</button>
        <small class="version">v1.0</small>
      </div>
    </aside>

    <div class="main">
      <header class="topbar">
        <button class="menu-toggle" aria-label="Alternar menu" title="Alternar menu">‚ò∞</button>
        <h1 class="page-title">Funcion√°rios</h1>
      </header>

      <main class="content" id="content">
        <section class="panel">
          <div class="panel-header">
            <h2>Vis√£o geral</h2>
            <div class="actions">
              <button class="btn primary" id="btnAction">Criar funcion√°rio</button>
            </div>
          </div>

          <div class="panel-body">
            <p class="empty">Carregando...</p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal de Configura√ß√µes do Servidor -->
  <div class="modal" id="serverConfigModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Configura√ß√µes do Servidor</h2>
        <button class="modal-close" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <div class="config-section">
          <label for="serverUrl">URL do Servidor:</label>
          <div class="input-group">
            <input type="text" id="serverUrl" placeholder="http://192.168.x.x:3001" />
            <button type="button" class="btn secondary" id="btnUseLocalhost">Usar localhost</button>
            <button type="button" class="btn secondary" id="btnUseDetected">Usar host atual</button>
          </div>
          <small class="help-text" id="hostHint">Exemplo: http://192.168.1.7:3001 ‚Äî use o IP do computador onde o servidor est√° rodando.</small>
        </div>

        <div class="config-section">
          <label for="enableServer">
            <input type="checkbox" id="enableServer" />
            <span>Ativar sincroniza√ß√£o com servidor</span>
          </label>
        </div>

        <div class="config-section">
          <button class="btn primary" id="btnTestConnection">Testar Conex√£o</button>
        </div>

        <div class="status-box" id="statusBox" style="display: none;">
          <div class="status-content">
            <span class="status-indicator" id="statusIndicator"></span>
            <div class="status-text">
              <strong id="statusTitle">Status</strong>
              <p id="statusMessage"></p>
            </div>
          </div>
        </div>

        <div class="config-section">
          <button class="btn secondary" id="btnSyncNow">Sincronizar Agora</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" id="btnCloseModal">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Overlay do Modal -->
  <div class="modal-overlay" id="serverConfigOverlay"></div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseClient.js"></script>

  <!-- Core Systems -->
  <script src="core-manager.js"></script>
  <script src="ui-manager.js"></script>

  <!-- Professional Features -->
  <script src="auth-manager.js"></script>
  <script src="export-manager.js"></script>
  <script src="notifications-manager.js"></script>
  <script src="analytics-manager.js"></script>
  <script src="cache-manager.js"></script>

  <!-- M√≥dulos de Dados -->
  <script src="dataSync.js"></script>
  <script src="funcionarios.js"></script>
  <script src="faltas.js"></script>
  <script src="quebras.js"></script>
  <script src="ceasa.js"></script>
  <script src="fornecedores.js"></script>
  <script src="relatorios.js"></script>
  <script src="dashboard.js"></script>

  <!-- Exemplos e Integra√ß√£o -->
  <script src="EXEMPLOS_INTEGRACAO.js"></script>
  <script>
    (async function () {
      const toggle = document.querySelector('.menu-toggle');
      toggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('sidebar-collapsed');
      });

      let currentSection = 'dashboard';

      const navItems = document.querySelectorAll('.nav-item');

      navItems.forEach(item => {
        const btn = item.querySelector('.nav-btn');

        btn.addEventListener('click', (e) => {
          const sub = item.querySelector('.subnav');
          if (sub) {
            // Fecha todos os outros submenus
            navItems.forEach(otherItem => {
              if (otherItem !== item) {
                otherItem.classList.remove('open');
                const otherBtn = otherItem.querySelector('.nav-btn');
                if (otherBtn) otherBtn.setAttribute('aria-expanded', 'false');
              }
            });
            
            const isOpen = item.classList.toggle('open');
            btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            return;
          }

          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');

          const label = item.querySelector('.nav-label') ? item.querySelector('.nav-label').textContent.trim() : '';
          if (label) document.querySelector('.page-title').textContent = label;

          const target = item.getAttribute('data-target');
          if (target) {
            currentSection = target;
            atualizarSecao(target);
          }
        });

        const subBtns = item.querySelectorAll('.subnav-btn');
        subBtns.forEach(sb => sb.addEventListener('click', (ev) => {
          ev.stopPropagation();
          document.querySelectorAll('.nav-item, .subnav-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          sb.parentElement.classList.add('active');

          const label = sb.textContent.trim();
          document.querySelector('.page-title').textContent = label;

          const target = sb.parentElement.getAttribute('data-target');
          currentSection = target;
          atualizarSecao(target);
        }));
      });

      const btnAction = document.getElementById('btnAction');
      if (btnAction) {
        btnAction.addEventListener('click', async () => {
          try {
            console.log('üîµ Bot√£o ADICIONAR clicado!');
            console.log('üìç currentSection:', currentSection);
            console.log('üìç Tipo do currentSection:', typeof currentSection);
            
            if (currentSection === 'funcionario') {
              console.log('‚û°Ô∏è Chamando FuncionariosUI.showCreatePage');
              await FuncionariosUI.showCreatePage();
            } else if (currentSection === 'faltas') {
              console.log('‚û°Ô∏è Chamando FaltasUI.showAddFaltaPage');
              await FaltasUI.showAddFaltaPage();
            } else if (currentSection === 'quebras') {
              console.log('‚û°Ô∏è Chamando quebrasUI.showAddQuebraPage');
              await quebrasUI.showAddQuebraPage();
            } else if (currentSection === 'ceasa-compras') {
              console.log('‚û°Ô∏è Chamando ceasaUI.showAddCompraPage');
              await ceasaUI.showAddCompraPage();
            } else if (currentSection === 'ceasa-fornecedores') {
              console.log('‚û°Ô∏è Chamando fornecedoresUI.showAddFornecedorPage');
              await fornecedoresUI.showAddFornecedorPage();
            } else if (currentSection.startsWith('relatorios-')) {
              console.log('‚û°Ô∏è Relat√≥rios - escondendo bot√£o');
              document.getElementById('btnAction').style.display = 'none';
            } else {
              console.warn('‚ö†Ô∏è currentSection n√£o reconhecido:', currentSection);
            }
            // Garantir que bot√£o fique vis√≠vel ap√≥s clique
            setTimeout(() => {
              const btn = document.getElementById('btnAction');
              if (btn) btn.style.display = 'block';
            }, 100);
          } catch (err) {
            console.error('Erro ao executar a√ß√£o do bot√£o:', err);
          }
        });
      }

      const atualizarSecao = async (secao) => {
        console.log('üîÑ atualizarSecao chamada com:', secao);
        currentSection = secao;
        console.log('üìç currentSection atualizado para:', currentSection);
        
        const btn = document.getElementById('btnAction');
        const actionsDiv = document.querySelector('.panel-header .actions');
        
        if (!btn) return;
        
        try {
          // Mostrar o actions div se ele estava escondido
          if (actionsDiv) {
            actionsDiv.style.display = 'block';
          }
          // Garantir que a visibilidade volte ap√≥s relat√≥rios
          btn.style.visibility = 'visible';
          
          // Mostrar o h2 se estava escondido
          const h2 = document.querySelector('.panel-header h2');
          if (h2) {
            h2.style.display = 'block';
          }
          
          if (secao === 'dashboard') {
            btn.style.display = 'none';
            if (actionsDiv) actionsDiv.style.display = 'none';
            await dashboardUI.renderDashboard();
          } else if (secao === 'funcionario') {
            btn.textContent = 'Criar funcion√°rio';
            btn.style.display = 'block';
            if (actionsDiv) actionsDiv.style.display = 'block';
            await FuncionariosUI.renderLista();
          } else if (secao === 'faltas') {
            btn.textContent = 'Adicionar falta';
            btn.style.display = 'block';
            if (actionsDiv) actionsDiv.style.display = 'block';
            await FaltasUI.renderLista();
          } else if (secao === 'quebras') {
            btn.textContent = 'Adicionar vale';
            btn.style.display = 'block';
            if (actionsDiv) actionsDiv.style.display = 'block';
            await quebrasUI.renderLista();
          } else if (secao === 'ceasa-compras') {
            btn.textContent = 'Adicionar compra';
            btn.style.display = 'block';
            if (actionsDiv) actionsDiv.style.display = 'block';
            await ceasaUI.renderLista();
          } else if (secao === 'ceasa-fornecedores') {
            btn.textContent = 'Adicionar fornecedor';
            btn.style.display = 'block';
            if (actionsDiv) actionsDiv.style.display = 'block';
            await fornecedoresUI.renderLista();
          } else if (secao === 'relatorios-quebras') {
            btn.style.display = 'none';
            if (actionsDiv) actionsDiv.style.display = 'none';
            await relat√≥riosUI.renderRelat√≥rioQuebras();
          } else if (secao === 'relatorios-faltas-atestados') {
            btn.style.display = 'none';
            if (actionsDiv) actionsDiv.style.display = 'none';
            await relat√≥riosUI.renderRelat√≥rioFaltasAtestados();
          } else if (secao === 'relatorios-ceasa') {
            btn.style.display = 'none';
            if (actionsDiv) actionsDiv.style.display = 'none';
            await relat√≥riosUI.renderRelat√≥rioCeasa();
          } else if (secao === 'relatorios-funcionarios') {
            btn.style.display = 'none';
            if (actionsDiv) actionsDiv.style.display = 'none';
            await relat√≥riosUI.renderRelat√≥rioFuncion√°rios();
          }
        } catch (err) {
          console.error('Erro ao atualizar se√ß√£o:', err);
          const btnRefresh = document.getElementById('btnAction');
          if (btnRefresh) {
            btnRefresh.style.display = 'block';
          }
          const actions = document.querySelector('.panel-header .actions');
          if (actions) {
            actions.style.display = 'block';
          }
        }
      };

      // Inicializar com o dashboard
      await atualizarSecao('dashboard');

      // Monitorar se o bot√£o desaparece e restaur√°-lo
      const panelHeader = document.querySelector('.panel-header');
      if (panelHeader) {
        const observer = new MutationObserver(() => {
          const btn = document.getElementById('btnAction');
          if (!btn && currentSection && !currentSection.startsWith('relatorios') && currentSection !== 'dashboard') {
            console.warn('Bot√£o desapareceu! Recriando...');
            const actions = document.querySelector('.panel-header .actions');
            if (actions) {
              const newBtn = document.createElement('button');
              newBtn.id = 'btnAction';
              newBtn.className = 'btn primary';
              newBtn.textContent = 'Adicionar';
              newBtn.style.display = 'block';
              newBtn.style.visibility = 'visible';
              actions.innerHTML = '';
              actions.appendChild(newBtn);
              // Reattach event listener
              newBtn.addEventListener('click', async () => {
                try {
                  if (currentSection === 'funcionario') {
                    await FuncionariosUI.showCreatePage();
                  } else if (currentSection === 'faltas') {
                    await FaltasUI.showAddFaltaPage();
                  } else if (currentSection === 'quebras') {
                    await quebrasUI.showAddQuebraPage();
                  } else if (currentSection === 'ceasa-compras') {
                    await ceasaUI.showAddCompraPage();
                  } else if (currentSection === 'ceasa-fornecedores') {
                    await fornecedoresUI.showAddFornecedorPage();
                  }
                } catch (err) {
                  console.error('Erro ao recriar bot√£o:', err);
                }
              });
            }
          }
        });
        observer.observe(panelHeader, { childList: true, subtree: true });
      }
    })();
  </script>
  <script>
    // Modal de Configura√ß√µes do Servidor
    (function() {
      const modal = document.getElementById('serverConfigModal');
      const overlay = document.getElementById('serverConfigOverlay');
      const btnSettings = document.getElementById('btnSettings');
      const btnCloseModal = document.getElementById('btnCloseModal');
      const modalClose = document.querySelector('.modal-close');
      const serverUrlInput = document.getElementById('serverUrl');
      const enableServerCheckbox = document.getElementById('enableServer');
      const btnTestConnection = document.getElementById('btnTestConnection');
      const btnSyncNow = document.getElementById('btnSyncNow');
      const btnUseLocalhost = document.getElementById('btnUseLocalhost');
      const btnUseDetected = document.getElementById('btnUseDetected');
      const hostHint = document.getElementById('hostHint');
      const statusBox = document.getElementById('statusBox');
      const statusIndicator = document.getElementById('statusIndicator');
      const statusTitle = document.getElementById('statusTitle');
      const statusMessage = document.getElementById('statusMessage');

      // Carregar configura√ß√µes salvas
      function loadSettings() {
        const savedUrl = DataSync.getServerUrl();
        const isEnabled = DataSync.isServerEnabled();
        const host = (window.location && window.location.hostname) ? window.location.hostname : '';
        const detectedUrl = host ? `http://${host}:3001` : '';
        
        if (savedUrl) {
          serverUrlInput.value = savedUrl;
        } else {
          // Prefill padr√£o
          serverUrlInput.value = detectedUrl || 'http://localhost:3001';
        }
        enableServerCheckbox.checked = isEnabled;

        // Atualizar dica de host
        if (host) {
          hostHint.textContent = `Host atual detectado: ${host} ‚Äî bot√£o 'Usar host atual' preencher√° ${detectedUrl}`;
          btnUseDetected.disabled = false;
        } else {
          btnUseDetected.disabled = true;
        }
      }

      // Abrir modal
      function openModal() {
        modal.classList.add('active');
        overlay.classList.add('active');
        loadSettings();
      }

      // Fechar modal
      function closeModal() {
        modal.classList.remove('active');
        overlay.classList.remove('active');
        statusBox.style.display = 'none';
      }

      // Mostrar status
      function showStatus(title, message, type = 'info') {
        statusBox.style.display = 'flex';
        statusBox.className = 'status-box ' + type;
        statusTitle.textContent = title;
        statusMessage.textContent = message;
      }

      // Testar conex√£o
      async function testConnection() {
        const url = serverUrlInput.value.trim();
        if (!url) {
          showStatus('Erro', 'Digite a URL do servidor', 'error');
          return;
        }

        btnTestConnection.disabled = true;
        btnTestConnection.textContent = 'Testando...';

        try {
          const controller = new AbortController();
          const timer = setTimeout(() => controller.abort(), 5000);
          const response = await fetch(url + '/health', { signal: controller.signal });
          clearTimeout(timer);
          if (response.ok) {
            showStatus('Conex√£o Sucesso!', 'Servidor est√° respondendo corretamente', 'success');
            DataSync.setServerUrl(url);
          } else {
            showStatus('Erro de Conex√£o', 'Servidor respondeu com erro: ' + response.status, 'error');
          }
        } catch (err) {
          showStatus('Erro de Conex√£o', 'N√£o foi poss√≠vel conectar ao servidor: ' + err.message, 'error');
        } finally {
          btnTestConnection.disabled = false;
          btnTestConnection.textContent = 'Testar Conex√£o';
        }
      }

      // Sincronizar agora
      async function syncNow() {
        if (!enableServerCheckbox.checked) {
          showStatus('Aviso', 'Ative a sincroniza√ß√£o primeiro', 'error');
          return;
        }

        btnSyncNow.disabled = true;
        btnSyncNow.textContent = 'Sincronizando...';
        showStatus('Sincronizando', 'Enviando dados para o servidor...', 'info');

        try {
          // Dados j√° est√£o sincronizados com o Supabase
          let sucessos = 0;

          showStatus('Sincroniza√ß√£o Conclu√≠da', sucessos + ' categorias sincronizadas com sucesso', 'success');
        } catch (err) {
          showStatus('Erro na Sincroniza√ß√£o', err.message, 'error');
        } finally {
          btnSyncNow.disabled = false;
          btnSyncNow.textContent = 'Sincronizar Agora';
        }
      }

      // Event Listeners
      btnSettings.addEventListener('click', openModal);
      btnCloseModal.addEventListener('click', closeModal);
      modalClose.addEventListener('click', closeModal);
      overlay.addEventListener('click', closeModal);

      enableServerCheckbox.addEventListener('change', () => {
        if (enableServerCheckbox.checked) {
          const url = serverUrlInput.value.trim();
          if (url) {
            DataSync.enableServer(url);
            showStatus('Ativado', 'Sincroniza√ß√£o com servidor ativada', 'success');
          } else {
            enableServerCheckbox.checked = false;
            showStatus('Erro', 'Digite a URL do servidor', 'error');
          }
        } else {
          DataSync.disableServer();
          showStatus('Desativado', 'Sincroniza√ß√£o com servidor desativada', 'info');
        }
      });

      btnTestConnection.addEventListener('click', testConnection);
      btnSyncNow.addEventListener('click', syncNow);
      btnUseLocalhost.addEventListener('click', () => {
        const url = 'http://localhost:3001';
        serverUrlInput.value = url;
        DataSync.setServerUrl(url);
        showStatus('URL Atualizada', 'Usando localhost:3001', 'success');
      });

      btnUseDetected.addEventListener('click', () => {
        const host = (window.location && window.location.hostname) ? window.location.hostname : '';
        if (!host) {
          showStatus('Sem host detectado', 'Abra a aplica√ß√£o via http para detectar o host', 'error');
          return;
        }
        const url = `http://${host}:3001`;
        serverUrlInput.value = url;
        DataSync.setServerUrl(url);
        showStatus('URL Atualizada', `Usando ${url}`, 'success');
      });

      // Salvar URL ao sair do input
      serverUrlInput.addEventListener('blur', () => {
        const url = serverUrlInput.value.trim();
        if (url) {
          DataSync.setServerUrl(url);
        }
      });

      // Fechar modal ao clicar fora
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    })();
  </script>
</body>
</html>