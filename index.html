<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GUF Sistemas — Projeto</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar" aria-label="Menu principal">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="3" width="18" height="18" rx="4" fill="#3B82F6"/>
            <path d="M7 12h10M7 16h6" stroke="#fff" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <strong class="app-name">GUF Sistemas</strong>
      </div>

      <nav class="nav">
        <ul>
          <li class="nav-item active" data-target="dashboard">
            <button class="nav-btn" aria-expanded="false">
              <span class="nav-icon" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="3" y="3" width="7" height="7" rx="1" fill="#1F2937"/>
                  <rect x="14" y="3" width="7" height="7" rx="1" fill="#1F2937"/>
                  <rect x="3" y="14" width="7" height="7" rx="1" fill="#1F2937"/>
                  <rect x="14" y="14" width="7" height="7" rx="1" fill="#1F2937"/>
                </svg>
              </span>
              <span class="nav-label">Dashboard</span>
            </button>
          </li>
          <li class="nav-item has-sub" data-target="funcionarios">
            <button class="nav-btn" aria-expanded="false">
              <span class="nav-icon" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z" fill="#1F2937"/>
                  <path d="M4 20a8 8 0 0116 0" stroke="#1F2937" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <span class="nav-label">Funcionários</span>
              <span class="chev" aria-hidden="true">▾</span>
            </button>

            <ul class="subnav" aria-label="Submenu funcionários">
              <li class="subnav-item" data-target="funcionario">
                <button class="subnav-btn">Funcionário</button>
              </li>
              <li class="subnav-item" data-target="faltas">
                <button class="subnav-btn">Faltas</button>
              </li>
              <li class="subnav-item" data-target="quebras">
                <button class="subnav-btn">Quebras de caixa</button>
              </li>
            </ul>
          </li>
          <li class="nav-item has-sub" data-target="ceasa">
            <button class="nav-btn" aria-expanded="false">
              <span class="nav-icon" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 10h18M5 14h14M4 18h16" stroke="#1F2937" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </span>
              <span class="nav-label">Ceasa</span>
              <span class="chev" aria-hidden="true">▾</span>
            </button>

            <ul class="subnav" aria-label="Submenu ceasa">
              <li class="subnav-item" data-target="ceasa-compras">
                <button class="subnav-btn">Compras</button>
              </li>
              <li class="subnav-item" data-target="ceasa-fornecedores">
                <button class="subnav-btn">Fornecedores</button>
              </li>
            </ul>
          </li>
          <li class="nav-item has-sub" data-target="relatorios">
            <button class="nav-btn" aria-expanded="false">
              <span class="nav-icon" aria-hidden="true">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M9 3h6v2H9V3zm-4 4h14v2H5V7zm0 4h14v2H5v-2zm0 4h10v2H5v-2z" fill="#1F2937"/>
                </svg>
              </span>
              <span class="nav-label">Relatórios</span>
              <span class="chev" aria-hidden="true">▾</span>
            </button>

            <ul class="subnav" aria-label="Submenu relatórios">
              <li class="subnav-item" data-target="relatorios-quebras">
                <button class="subnav-btn">Quebras de caixa</button>
              </li>
              <li class="subnav-item" data-target="relatorios-faltas-atestados">
                <button class="subnav-btn">Faltas e Atestados</button>
              </li>
              <li class="subnav-item" data-target="relatorios-ceasa">
                <button class="subnav-btn">Ceasa</button>
              </li>
            </ul>
          </li>
        </ul>
      </nav>

      <div class="sidebar-footer">
        <button class="btn-settings" id="btnSettings" title="Configurações do servidor" aria-label="Configurações">⚙️</button>
        <small class="version">v1.0</small>
      </div>
    </aside>

    <div class="main">
      <header class="topbar">
        <button class="menu-toggle" aria-label="Alternar menu" title="Alternar menu">☰</button>
        <h1 class="page-title">Funcionários</h1>
      </header>

      <main class="content" id="content">
        <section class="panel">
          <div class="panel-header">
            <h2>Visão geral</h2>
            <div class="actions">
              <button class="btn primary" id="btnAction">Criar funcionário</button>
            </div>
          </div>

          <div class="panel-body">
            <p class="empty">Carregando...</p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal de Configurações do Servidor -->
  <div class="modal" id="serverConfigModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Configurações do Servidor</h2>
        <button class="modal-close" aria-label="Fechar">&times;</button>
      </div>
      <div class="modal-body">
        <div class="config-section">
          <label for="serverUrl">URL do Servidor:</label>
          <div class="input-group">
            <input type="text" id="serverUrl" placeholder="http://192.168.x.x:3001" />
            <button type="button" class="btn secondary" id="btnUseLocalhost">Usar localhost</button>
            <button type="button" class="btn secondary" id="btnUseDetected">Usar host atual</button>
          </div>
          <small class="help-text" id="hostHint">Exemplo: http://192.168.1.7:3001 — use o IP do computador onde o servidor está rodando.</small>
        </div>

        <div class="config-section">
          <label for="enableServer">
            <input type="checkbox" id="enableServer" />
            <span>Ativar sincronização com servidor</span>
          </label>
        </div>

        <div class="config-section">
          <button class="btn primary" id="btnTestConnection">Testar Conexão</button>
        </div>

        <div class="status-box" id="statusBox" style="display: none;">
          <div class="status-content">
            <span class="status-indicator" id="statusIndicator"></span>
            <div class="status-text">
              <strong id="statusTitle">Status</strong>
              <p id="statusMessage"></p>
            </div>
          </div>
        </div>

        <div class="config-section">
          <button class="btn secondary" id="btnSyncNow">Sincronizar Agora</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" id="btnCloseModal">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Overlay do Modal -->
  <div class="modal-overlay" id="serverConfigOverlay"></div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseClient.js"></script>

  <!-- Supabase Ceasa Module -->
  <script type="module" src="supasabe-ceasa.js"></script>

  <script src="dataSync.js"></script>
    <script src="funcionarios.js"></script>
  <script src="faltas.js"></script>
  <script src="quebras.js"></script>
  <script src="ceasa.js"></script>
  <script src="fornecedores.js"></script>
  <script src="relatorios.js"></script>
  <script src="dashboard.js"></script>
  <script>
    (async function () {
      const toggle = document.querySelector('.menu-toggle');
      toggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('sidebar-collapsed');
      });

      let currentSection = 'dashboard';

      const navItems = document.querySelectorAll('.nav-item');

      navItems.forEach(item => {
        const btn = item.querySelector('.nav-btn');

        btn.addEventListener('click', (e) => {
          const sub = item.querySelector('.subnav');
          if (sub) {
            // Fecha todos os outros submenus
            navItems.forEach(otherItem => {
              if (otherItem !== item) {
                otherItem.classList.remove('open');
                const otherBtn = otherItem.querySelector('.nav-btn');
                if (otherBtn) otherBtn.setAttribute('aria-expanded', 'false');
              }
            });
            
            const isOpen = item.classList.toggle('open');
            btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            return;
          }

          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');

          const label = item.querySelector('.nav-label') ? item.querySelector('.nav-label').textContent.trim() : '';
          if (label) document.querySelector('.page-title').textContent = label;

          const target = item.getAttribute('data-target');
          if (target) {
            currentSection = target;
            atualizarSecao(target);
          }
        });

        const subBtns = item.querySelectorAll('.subnav-btn');
        subBtns.forEach(sb => sb.addEventListener('click', (ev) => {
          ev.stopPropagation();
          document.querySelectorAll('.nav-item, .subnav-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          sb.parentElement.classList.add('active');

          const label = sb.textContent.trim();
          document.querySelector('.page-title').textContent = label;

          const target = sb.parentElement.getAttribute('data-target');
          currentSection = target;
          atualizarSecao(target);
        }));
      });

      const btnAction = document.getElementById('btnAction');
      btnAction.addEventListener('click', () => {
        if (currentSection === 'funcionario') {
          FuncionariosUI.showCreatePage();
        } else if (currentSection === 'faltas') {
          FaltasUI.showAddFaltaPage();
        } else if (currentSection === 'quebras') {
          quebrasUI.showAddQuebraPage();
        } else if (currentSection === 'ceasa-compras') {
          ceasaUI.showAddCompraPage();
        } else if (currentSection === 'ceasa-fornecedores') {
          fornecedoresUI.showAddFornecedorPage();
        } else if (currentSection.startsWith('relatorios-')) {
          // Relatórios não têm botão de ação
          btnAction.style.display = 'none';
        }
      });

      const atualizarSecao = async (secao) => {
        if (secao === 'dashboard') {
          btnAction.style.display = 'none';
          await dashboardUI.renderDashboard();
        } else if (secao === 'funcionario') {
          await FuncionariosUI.renderLista();
          btnAction.textContent = 'Criar funcionário';
          btnAction.style.display = 'block';
        } else if (secao === 'faltas') {
          await FaltasUI.renderLista();
          btnAction.textContent = 'Adicionar falta';
          btnAction.style.display = 'block';
        } else if (secao === 'quebras') {
          await quebrasUI.renderLista();
          btnAction.textContent = 'Adicionar vale';
          btnAction.style.display = 'block';
        } else if (secao === 'ceasa-compras') {
          await ceasaUI.renderLista();
          btnAction.textContent = 'Adicionar compra';
          btnAction.style.display = 'block';
        } else if (secao === 'ceasa-fornecedores') {
          await fornecedoresUI.renderLista();
          btnAction.textContent = 'Adicionar fornecedor';
          btnAction.style.display = 'block';
        } else if (secao === 'relatorios-quebras') {
          btnAction.style.display = 'none';
          await relatóriosUI.renderRelatórioQuebras();
        } else if (secao === 'relatorios-faltas-atestados') {
          btnAction.style.display = 'none';
          await relatóriosUI.renderRelatórioFaltasAtestados();
        } else if (secao === 'relatorios-ceasa') {
          btnAction.style.display = 'none';
          await relatóriosUI.renderRelatórioCeasa();
        } else if (secao === 'relatorios-funcionarios') {
          btnAction.style.display = 'none';
          await relatóriosUI.renderRelatórioFuncionários();
        }
      };

      // Inicializar com o dashboard
      await atualizarSecao('dashboard');
    })();
  </script>
  <script>
    // Modal de Configurações do Servidor
    (function() {
      const modal = document.getElementById('serverConfigModal');
      const overlay = document.getElementById('serverConfigOverlay');
      const btnSettings = document.getElementById('btnSettings');
      const btnCloseModal = document.getElementById('btnCloseModal');
      const modalClose = document.querySelector('.modal-close');
      const serverUrlInput = document.getElementById('serverUrl');
      const enableServerCheckbox = document.getElementById('enableServer');
      const btnTestConnection = document.getElementById('btnTestConnection');
      const btnSyncNow = document.getElementById('btnSyncNow');
      const btnUseLocalhost = document.getElementById('btnUseLocalhost');
      const btnUseDetected = document.getElementById('btnUseDetected');
      const hostHint = document.getElementById('hostHint');
      const statusBox = document.getElementById('statusBox');
      const statusIndicator = document.getElementById('statusIndicator');
      const statusTitle = document.getElementById('statusTitle');
      const statusMessage = document.getElementById('statusMessage');

      // Carregar configurações salvas
      function loadSettings() {
        const savedUrl = DataSync.getServerUrl();
        const isEnabled = DataSync.isServerEnabled();
        const host = (window.location && window.location.hostname) ? window.location.hostname : '';
        const detectedUrl = host ? `http://${host}:3001` : '';
        
        if (savedUrl) {
          serverUrlInput.value = savedUrl;
        } else {
          // Prefill padrão
          serverUrlInput.value = detectedUrl || 'http://localhost:3001';
        }
        enableServerCheckbox.checked = isEnabled;

        // Atualizar dica de host
        if (host) {
          hostHint.textContent = `Host atual detectado: ${host} — botão 'Usar host atual' preencherá ${detectedUrl}`;
          btnUseDetected.disabled = false;
        } else {
          btnUseDetected.disabled = true;
        }
      }

      // Abrir modal
      function openModal() {
        modal.classList.add('active');
        overlay.classList.add('active');
        loadSettings();
      }

      // Fechar modal
      function closeModal() {
        modal.classList.remove('active');
        overlay.classList.remove('active');
        statusBox.style.display = 'none';
      }

      // Mostrar status
      function showStatus(title, message, type = 'info') {
        statusBox.style.display = 'flex';
        statusBox.className = 'status-box ' + type;
        statusTitle.textContent = title;
        statusMessage.textContent = message;
      }

      // Testar conexão
      async function testConnection() {
        const url = serverUrlInput.value.trim();
        if (!url) {
          showStatus('Erro', 'Digite a URL do servidor', 'error');
          return;
        }

        btnTestConnection.disabled = true;
        btnTestConnection.textContent = 'Testando...';

        try {
          const controller = new AbortController();
          const timer = setTimeout(() => controller.abort(), 5000);
          const response = await fetch(url + '/health', { signal: controller.signal });
          clearTimeout(timer);
          if (response.ok) {
            showStatus('Conexão Sucesso!', 'Servidor está respondendo corretamente', 'success');
            DataSync.setServerUrl(url);
          } else {
            showStatus('Erro de Conexão', 'Servidor respondeu com erro: ' + response.status, 'error');
          }
        } catch (err) {
          showStatus('Erro de Conexão', 'Não foi possível conectar ao servidor: ' + err.message, 'error');
        } finally {
          btnTestConnection.disabled = false;
          btnTestConnection.textContent = 'Testar Conexão';
        }
      }

      // Sincronizar agora
      async function syncNow() {
        if (!enableServerCheckbox.checked) {
          showStatus('Aviso', 'Ative a sincronização primeiro', 'error');
          return;
        }

        btnSyncNow.disabled = true;
        btnSyncNow.textContent = 'Sincronizando...';
        showStatus('Sincronizando', 'Enviando dados para o servidor...', 'info');

        try {
          // Sincronizar todas as categorias
          const categorias = ['quebras', 'faltas', 'ceasa', 'funcionarios', 'fornecedores'];
          let sucessos = 0;

          for (const categoria of categorias) {
            const dados = localStorage.getItem(categoria);
            if (dados) {
              try {
                await DataSync.syncWithServer(categoria, JSON.parse(dados));
                sucessos++;
              } catch (e) {
                console.warn('Erro ao sincronizar ' + categoria, e);
              }
            }
          }

          showStatus('Sincronização Concluída', sucessos + ' categorias sincronizadas com sucesso', 'success');
        } catch (err) {
          showStatus('Erro na Sincronização', err.message, 'error');
        } finally {
          btnSyncNow.disabled = false;
          btnSyncNow.textContent = 'Sincronizar Agora';
        }
      }

      // Event Listeners
      btnSettings.addEventListener('click', openModal);
      btnCloseModal.addEventListener('click', closeModal);
      modalClose.addEventListener('click', closeModal);
      overlay.addEventListener('click', closeModal);

      enableServerCheckbox.addEventListener('change', () => {
        if (enableServerCheckbox.checked) {
          const url = serverUrlInput.value.trim();
          if (url) {
            DataSync.enableServer(url);
            showStatus('Ativado', 'Sincronização com servidor ativada', 'success');
          } else {
            enableServerCheckbox.checked = false;
            showStatus('Erro', 'Digite a URL do servidor', 'error');
          }
        } else {
          DataSync.disableServer();
          showStatus('Desativado', 'Sincronização com servidor desativada', 'info');
        }
      });

      btnTestConnection.addEventListener('click', testConnection);
      btnSyncNow.addEventListener('click', syncNow);
      btnUseLocalhost.addEventListener('click', () => {
        const url = 'http://localhost:3001';
        serverUrlInput.value = url;
        DataSync.setServerUrl(url);
        showStatus('URL Atualizada', 'Usando localhost:3001', 'success');
      });

      btnUseDetected.addEventListener('click', () => {
        const host = (window.location && window.location.hostname) ? window.location.hostname : '';
        if (!host) {
          showStatus('Sem host detectado', 'Abra a aplicação via http para detectar o host', 'error');
          return;
        }
        const url = `http://${host}:3001`;
        serverUrlInput.value = url;
        DataSync.setServerUrl(url);
        showStatus('URL Atualizada', `Usando ${url}`, 'success');
      });

      // Salvar URL ao sair do input
      serverUrlInput.addEventListener('blur', () => {
        const url = serverUrlInput.value.trim();
        if (url) {
          DataSync.setServerUrl(url);
        }
      });

      // Fechar modal ao clicar fora
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
        }
      });
    })();
  </script>
</body>
</html>